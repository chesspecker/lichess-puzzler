const buildColl = db.puzzle2;
const playColl = db.puzzle2_puzzle;

const blocklist =
  'zZfgA zv6an H90hm wvS0G hFkPs lZVnm 034qW C5e84 fYq7m jEuKH L5SwI gwHuW pTDl0 8VWpS M7roz sdiop SGlpF oWAtt tlIPq x9P07 0BFLx dNe56 iPBjJ QzDRj 5tvXh 3uBEo U59Qd I4Irr 3SP3z VzVm4 1wGif 3uTON W5L12 4zTfn l6TiL KsFdB B14ca XJH7C kLJCW FH0cv 6jZth xkTiD T0c89 dy5oW KStaC jJ2AW aHJpU nxHSp NUpxQ eAuHw IxQS9 Nbhnq YoaMi WSfjT 8yCUh ZuSM5 0NxWX Rlzel 9ONFV XUM3f nRiiN KnbG4 Awj23 bJYFT YPWD3 MyOns CIyLE NYzO4 PKLkI QHYQV qEwbA 0LFq6 6xxRG NQwGg a4Cws l7PHy URYKl APTcO CDjbe O6C96 Qm2Tr wb76k kqiQ2 k6gYd qKBcM MHlgu eaSi4 ynV4e epnjQ uLEPU 73BrE 5ToDy C5R7g O1XHr l4Mqx tm3er Kw4wd bR8BU FTrzs Ygjsh LmDzM EePXY 4bepr jexKg JK5UB H7ND7 pYnkM Ukrhc 9vI8A hli1A Ht9Hv fV309 UAlRc xJBQx E9I6x kp5co k41OF 4isK0 poW56 BjYjD qQjr1 QtJ8Y yFrM3 qWF71 d4CXy 3phiS mSxQw DUyVa z3Vax QVa3K C5Q6E rjS4h D48BI ADn6b HyZjT 67si6 i6hpL WTA9E chn2w pT5sP UlLOo gYONI LXFqv tzkKz ElTUD hR1Wr 1a3ac E9ce2 RhUOx TDlkO eTx75 gaEj5 QEcNf hkcSu eREp0 jipPb hyPF8 r9DTF jHUQz a9Jf2 xFRmt kVxuv rVv8U dAgMr 7WWCy 864NH SAJwM ymoiv QSnpz ShC6V Ilkhr SmIG8 ehFgV 36T1D FuiZd iHeXz MWObs QTQXs TPeAQ Abg9H pmd4t 0XVra CKSDn 9P78D P2ecr oijY1 gnb5Y Izy1M n3uJ8 ZmAz5 QU4W9 O2WpD pk4ZP 5X4ws qufVT so9XG OmPzu WxD1q aEqsb J90Dv rKjtQ MbMvE DVgFn KClu5 UChfM s7nHm 3O5hZ eQ3dF 8Urr9 ulZQC TOo80 Ti6OF Ib00s NbLPS RQLDY Qzfns BodBW 8iyCU WpTjU fEqPu 6Gw4X 8YerT UFwbD kxdyi Vro0G 7JoRa xxCGc KiRpe yzTDp oFKlL GfCey fzqXY JM3Oi MfRgC D8Is6 9gRBQ aZA2E DGRGq IAmuX 7kxXk X6Ouz vlmzA QPlRQ 7aYIM 4QK8g G9HVD TYqQg w7B1B 5Zl9D AyVYO LDH9c CDMr8 aRxWY pMCI3 VyiLO u0Vt9 SSFCq 1OyI9 iumYR DhEGo ScWiu wLF5p xgDL7 OQ9LQ OShoC h7wfU cWZ8d l1uIK 8hpbj jXyLb 4h7SU lgBIK p5FMZ y1HZz OOtcn NZWZu YaUhp W2jar aNMez pDlsC 3Qbbp 8kqIx atkK0 9aKCA 6n1uD QRdHy 4rhYe KuRZI FVN3a WN5PD nunoF WVlBd hOQyE JOGHR kASdu 6DuKA QToeY txDP4 vhqnu InyAN mSUWB mwzRY DHvnF C0cQ8 5Rbom Ba7lO 409sk KziQ9 APPqb BVX2q iZWer sv2Ct fSGr0 iLKHO dPQeJ p4Dbb 9MaEh svVdP fBW6z cpOui OO6nd rUphz yb8ck S2WE9 YOvx8 2L0jc QXHEv m1YnI pbvQR WuH0P rnFT3 VjxTq qPkYQ OivtA Xi0rf HmydS Y9Ysz znOWn nsOm0 d7SzA JsL3K t8dvC Tpc7S 5asD7 Phs60 vPsaP Qc1hU fpH3L FkEGA ovtmM ZpFor 1hZkW W4evP x2uTL pHycY YauPY g8Q75 U62fH Pd8R0 0enn7 Uakgh xn9rj TusZS Ivq97 6apoo zXLcf l7jb9 Fyfa3 aVW7x 9CSGg Hshg2 Zi5oT k56iK nrNaZ 5LCGC HrwLw 7PBgr Nbofc WBmM9 Y9z3C pd5Vp ir6lQ owbsF QPHjS b6ry9 5BShd TGDOW ofStc CMT66 6c4PV NuI2H 6kdL4 Czx2X hRo20 snDwA veQOV cDJ6h 3PeGY L7RF5 K9XFw 81H8U hZKrp 9NAdj Bfnoq SZg6h 4OvRg AUtLE wegTm gz52d hKpKx 9Xx2g iBIKW trlSC f6BIr OPRKw kW1uP IQfNf d1c8H D8Z3u HKRiC Pjys4 LGF4q n0R9J n8br9 ipMsK Ad2Bz 24Va7 t8PDl QGU2W fmQFn pRwrk W48oo Q1f2B ZzgN2 onCeq d8s4l LzQoV 1NHno rBnOe d9Ik5 3HoLz Ent4w 3p5ZP YubAe q4buo ZGgiN BMbRr DrHs4 SrQob fP9sX auNwy t89Kh vP0eZ 0Jcsf 1PIdq aVmoJ olnqN U4mq3 AmNj3 u60qZ Vnznu 25o87 Q9LBH F4UuY CkeKA HecB7 edLRv YtCQO v0091 SG7Ox 09daJ AYlUM EFcTj IPfPk CAwlF ERVwp 9l6AZ 6sIfe ydqBO F27wA RM8D1 8snLR tSYk3 tck6M ytgMW 6r6Rq 5kP48 8sGha GxjHe nBqNu aM13i GkoOI WKlAt 510MZ vfV9N pFs3j IlZcF a0cLv dzJUh jBUOV EWLP3 LWSmF 8HWtb fVKHL r7hul YnVVm kAuwS WUV7i 8fEuU Byzcx IKz7V j80ir A6r8E ozc6y VgI0M 7ssWc iI3P6 iEyIG bfKjA SzxK5 9ICZc tS4ox Z5Ryd 4JolL kquFa 2mHPh wug0H Zidvw pRscU APfWy BC2gt u3wOk gDEwQ CZ9rS 5cC75 remGb KGjV6 WHa8W zaDI7 hdt4j cceXB Q2dln BaC6K irheS XclY5 qoiZt 2m4td ZcWmW CJkK9 PPC5a 9qRPl uNb25 SfjYT LKVyJ QECPJ K5GDu 2umhS GLILQ tkB4F FIQf4 bEtXR rAbtJ NwdPf HPGVx nzbaO OM0hh iIoTG 58MP5 irUMS UAqLr OKA9Z LlmiC q9L4s 9nNSs fFZI3 piRpi eQ9K7 Yzyrn 15AlC 2uZRP 4W7Ln NsLdd FBjv2 xcTjo 8Xfzk o3ZqX BqzGx W11w4 6UxWy KasIu TCVnf GZSz2 X0eLF lxVRc q89NA mB5mQ hGzMC WcfK7 YpmqT rUzVm 4WFF9 4dPF4 ypuV0 HI9nh RmPw3 5vyhs ImVpx u7Vy5 dqcW0 i5Y0X cDyUn klZZp HS3ai F5GPw yTLYS IGVta 8YJnQ yJkqw sYrrP ccX9h 38WGK KRaDj QgPYn 5jx1q eOiRe mNDSJ p1Wk5 mEqv6 IhbUm AdmH1 cmXmP 3012k qCxBZ ahw2B nx1LH lufoO 3uAG0 Z3Mg1 hDid9 mhpfJ M9GPU L8BJP j4lvU RxBgR PZlxs qVazO Xl5mu lR8TB EFG5v F9oJ4 ea3fy KUeQP 7lRvR qQqJh rBWhm vDK22 vFjud 9LucO FQRhN 37Gd1 U4RTc hjoAR dGDar 2FBzv X91eN 61vX7 KEoMI WsipP bpJMx IgljE fNQXl omysi yMU3Q CsyZM nJHKP DKUiu YANGN RAWPL BmcIj Zcrzl mPVwx q2iY0 5jRoj GNOXK DLx0R Kilqu mOAsl FWqUc KRzKH r13U9 Npg6F 5sJju BvfWU RDwlV tNq33 rItHs EKa6s 3sL7j HgG79 674mL sde8O wdGMr B10kK lO8Bu eeXxB 2Slfb yltMR F8PqT FWwvA d80Ym IE6Ot i6XkB 8Ya7n wxV2U ExEx5 H56EF dyci3 PHEKw YAPnF 8c6hI wm8AH H76Sy tDO5V rQtU1 79vzL b5GBY 8vhya A4Snw TKrIr Gva9p vVgaa LxOmc GPkLf Vdw18 tE9DE LZJZF fPtZ0 vjH7E lEMfS XPiKy QdLft HGi1j Tvqvi lHqSk lOwFF Cn9Ht lLQ9f rLNcV SkYN4 oJAbG o5bdk mqta1 PNzYU b5GTj dWYuE 080Xd lX1oc UVC4j H7wJT 0kOvo EMPyp L8dNR tkcY7 8dXPf oJAtJ YtkUp r9hkd 4tU84 9m81W VJIsm XG3hO VNVVm HB6wK HBIG0 ZKjRj y1rlA Eqtv1 nFbJX o14Mz wh9Uw IEj4a hVnbJ MFcGR buhzg CZA1Q NgeCT IkRB1 JwPBo mZDRD 9dmMH U8T0y AR5AY gz6qy DjBUG ie8ms l4s34 4ZrQv yax5X 7QEob d11yY gUuCx dFQAb 6wneR tk65c twcoW GbCSh eqHqG aayMa J2AD9 IdJRh fejcz Rhq6U bQW5M lLdsr ypFrf 3q1ad wiGjq tVvkQ kriBa'.split(
    ' '
  );

buildColl.remove({ _id: { $in: blocklist } });
playColl.remove({ _id: { $in: blocklist } });

buffer = [];

function process(buf) {
  const existingIds = new Set(playColl.distinct('_id', { _id: { $in: buf.map(p => p._id) } }));
  const missing = buf
    .filter(p => !existingIds.has(p._id))
    .map(p => ({
      _id: p._id,
      gameId: p.gameId,
      fen: p.fen,
      themes: [],
      glicko: {
        r: 1500,
        d: 500,
        v: 0.09,
      },
      plays: NumberInt(0),
      vote: 1,
      vu: NumberInt(10),
      vd: NumberInt(0),
      line: p.moves.join(' '),
      cp: p.cp,
    }));
  if (missing.length) playColl.insertMany(missing, { ordered: false });
}

buildColl.find({ _id: { $nin: blocklist } }).forEach(p => {
  if (p.moves.length < 2) return;
  buffer.push(p);
  if (buffer.length >= 1000) {
    process(buffer);
    buffer = [];
  }
});

process(buffer);
